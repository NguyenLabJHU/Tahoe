# $Id: make.targets,v 1.2 2001-01-31 02:12:21 paklein Exp $
#
# platform specific instructions
include $(MACRO_DIR)/$(ARCH).macros

# include list of object files
OBJECT_LIST = $(OBJ_DIR)/obj.junk
include $(OBJECT_LIST)

#########################################################################
# grouped
OPT_CFLAGS = \
	$(TB_CFLAGS) \
	$(ACME_CFLAGS) \
	$(SPOOLESMPI_CFLAGS) \
	$(SPOOLES_CFLAGS) \
	$(AZ_CFLAGS) \
	$(BLAS_CFLAGS) \
	$(AX_CFLAGS) \
	$(F2C_CFLAGS)

OPT_LFLAGS = \
	$(TB_LFLAGS) \
	$(ACME_LFLAGS) \
	$(SPOOLESMPI_LFLAGS) \
	$(SPOOLES_LFLAGS) \
	$(AZ_LFLAGS) \
	$(BLAS_LFLAGS) \
	$(AX_LFLAGS) \
	$(F2C_LFLAGS)

OPT_LIB = \
	$(TB_LIB) \
	$(F2C_LIB) \
	$(BLAS_LIB) \
	$(AZ_LIB) \
	$(SPOOLES_LIB) \
	$(SPOOLESMPI_LIB) \
	$(ACME_LIB)

OPT_INC = \
	$(TB_INC) \
	$(F2C_INC) \
	$(BLAS_INC) \
	$(AZ_INC) \
	$(SPOOLES_INC) \
	$(SPOOLESMPI_INC) \
	$(ACME_INC) \
	$(AX_INC)
#########################################################################
# paths for file dependencies
DEPEND_FILE = all.depend
DEPEND_PATH = -I$(INC_DIR) $(OPT_INC) $(INC_FLAGS)

# Sun spends too much time searching standard directories
#DEPEND_PATH = -Y -I$(INC_DIR) $(OPT_INC)
#########################################################################

# default target
help:
	@ echo " make targets:"
	@ echo "   init - (re-)initialize headers and file dependencies"
	@ echo "  build - (re-)build binaries"
	@ echo "objects - (re-)compile object file, but don't link"
	@ echo "  clean - remove object files and build temporaries"
	@ echo "   help - display this list"

# instructions
build: objects $(BUILD)

$(TARGET): $(OPT_LIB) $(LIBRARY)
	@ echo " linking..."	
	@ $(LINK) $(MAIN) -o $(TARGET) -L$(HOME_DIR)/lib -l$(TARGET) $(OPT_LFLAGS) $(LFLAGS)
	@ echo "    ...wrote $(TARGET)"; echo " "

# include object list and create archive
$(LIBRARY): $(LIB_DIR)/lib.junk
	@ echo " building archive..."
	@ $(MAKE) build_library \
	"OBJECT_LIST = $(HOME_DIR)/object_list" \
	"AR = $(AR)" \
	"ARFLAGS = $(ARFLAGS)" \
	"LIBRARY = $(LIBRARY)"

# create archive
build_library:
	@ cd $(OBJ_DIR); $(AR) $(ARFLAGS) $(LIBRARY) $(OBJ)	

# initialization
init:
	@ $(MAKE) headers
	@ $(MAKE) depend_init
	@ $(MAKE) object_list

# clean up - restore to unpacked state
RM_FILES = *.o *.i *.*~ *.bak ii_* *.d all.depend
clean:
	@- rm $(TARGET) object_list
	@- rm $(LIBRARY)
	@- cd $(SRC_DIR); $(MAKE) $(MAKE_OPTS) clean \
	"MAKE = $(MAKE)" \
	"RM = $(RM)" \
	"RM_FILES = $(RM_FILES)" \
	"MAKE_OPTS = $(MAKE_OPTS)"
	@- cd $(OBJ_DIR); rm *.o
	@- cd $(MACRO_DIR)/cxx_repository; rm *.o *.DB
	@- cd $(INC_DIR); rm *.h

# build object file list
object_list: FORCE
	@ echo "collecting list of object files"
	@ echo "OBJ = \c" > object_list
	@ cd $(SRC_DIR); \
	$(MAKE) library \
	"MAKE = $(MAKE)" \
	"AR = $(AR)" \
	"ARFLAGS = $(ARFLAGS)" \
	"LIBRARY = $(HOME_DIR)/object_list" \
	"LIB_DIR = $(LIB_DIR)"
	@ echo "" >> object_list

# set symbolic links to all header files
headers:
	@ echo "cd $(SRC_DIR)"; \
	cd $(SRC_DIR); \
	$(MAKE) $(MAKE_OPTS) headers \
	"MAKE = $(MAKE)" \
	"LN = $(LN)" \
	"INC_DIR = $(INC_DIR)" \
	"CURR_DIR = $(SRC_DIR)" \
	"MAKE_OPTS = $(MAKE_OPTS)"

# initialize dependency files
depend_init:
	@ echo "cd $(SRC_DIR)"; \
	cd $(SRC_DIR); \
	$(MAKE) $(MAKE_OPTS) depend_init \
	"MAKE = $(MAKE)" \
	"MAKE_DEPEND = $(MAKE_DEPEND)" \
	"DEPEND_PATH = $(DEPEND_PATH)" \
	"MAKE_OPTS = $(MAKE_OPTS)"

# build objects
objects:
	@ echo "cd $(SRC_DIR)"; \
	cd $(SRC_DIR); \
	$(MAKE) $(MAKE_OPTS) objects \
	"MAKE = $(MAKE)" \
    "LN = $(LN)" \
	"MAKE_OPTS = $(MAKE_OPTS)" \
	"INC_DIR = $(INC_DIR)" \
	"OBJ_DIR = $(OBJ_DIR)" \
	"LIB_DIR = $(LIB_DIR)" \
	"TR = $(TR)" \
	"COMP_C = $(COMP_C)" \
	"COMP_CC = $(COMP_CC)" \
	"COMP_F = $(COMP_F)" \
	"CFLAGS_C = $(OPT_CFLAGS) $(CFLAGS_C)" \
	"CFLAGS_CC = $(OPT_CFLAGS) $(CFLAGS_CC)" \
	"CFLAGS_F = $(OPT_CFLAGS) $(CFLAGS_F)" \
	"MAKE_DEPEND = $(MAKE_DEPEND)" \
	"DEPEND_PATH = $(DEPEND_PATH)" \
	"DEPEND = $(DEPEND_FILE)" \
	"CURR_DIR = $(SRC_DIR)"

FORCE:
