## radii of fit : from 9 test average
##radii: 17.9829, 17.7144, 24.193
# {Rnt = 17.9829}
# {Ris = 17.7144}
# {Rz  = 24.193}
## apex thickness : 1.16 - 1.10, across cornea, shrink with time
## 2D0 thickness sensistivity
# {Zapex = 1.15}
## meridians : NT : 27.1 - 28.9 ave 28.07, IS : 21.5 - 23.2 ave 22.35
# {Mnt = 12.75}
# {Mis = 10.25}
# {M = 0.5*(Mnt+Mis)}
## collar
# {Cnt = Mnt}
# {Cis = Mis}
## end of fixture
# {fD = 1.1 }
## transition
# {fB = 0.95 }
## mesh size
# {hsize = 1.0}
## units conversion
# {inch2mm = 25.4}

# create cutting tool
import "holder.IGS"
group "holder" add volume all
surface 10 name "cutter"
volume all scale X {inch2mm} Y {inch2mm} Z {inch2mm}
volume 1 to 36 scale X {fD} Y {fD} Z {fD}

# create ellipsoid
create sphere radius 1
volume {Id("volume")} scale X {Rnt} Y {Ris} Z {Rz}
volume {Id("volume")} name "outerEllipse"
move volume outerEllipse z {-Rz}

#webcut 1
webcut outerEllipse sweep curve in cutter vector 0 0 -1 distance {3*Rz}
split outerEllipse
delete outerEllipse outerEllipse@A
volume outerEllipse@B  name "cornea"

#webcut 2
volume 1 to 36 scale X {1.0/fD} Y {1.0/fD} Z {1.0/fD}
webcut cornea sweep curve in cutter vector 0 0 -1 distance {3*Rz}
volume 1 to 36 scale X {fB} Y {fB} Z {fB}

#webcut 3
webcut cornea sweep curve in cutter vector 0 0 -1 distance {3*Rz}
section cornea cornea@A cornea@B with yplane reverse
delete volume 1 to 36

# inner ellipse
create sphere radius 1
volume {Id("volume")} scale X {Rnt-Zapex} Y {Ris-Zapex} Z {Rz-Zapex}
volume {Id("volume")} name "innerEllipse"
move volume innerEllipse z {-Rz}
subtract innerEllipse from cornea cornea@A cornea@B 
split  volume all
delete cornea cornea@B cornea@D 

webcut volume all with xplane

#volume outerEllipse@A  name "cornea"
### measure between vertex 667 and vertex 876 
### DX = 26.26735954230647
### 12.857065 -13.410294


# mesh
merge volume all
imprint volume all

#pause

# top inner B A, transition F E outer D C
surface 312 306 scheme triprimitive
surface 332 326 321 317 scheme map

# trans, outer radial
curve 915 1217 938 interval 3
curve 819 1200 928 interval 1

# left circum
curve 858 762 624 interval 5
curve 863 767 625 interval 3
curve 855 759 626 interval 3
curve 833 737 627 interval 3
curve 1199 1214 1212 interval 3

# right circum
curve 1192 1206 1207 interval 7
curve 840 744 629 interval 3
curve 843 747 630 interval 3
curve 846 750 631 interval 3
curve 849 753 632 interval 1
curve 830 734 633 interval 3

mesh surface 312 306 332 326 321 317

#pause

curve 1203 1067 1065 994 1190 991 1086 1084 interval 3

volume cornea@B scheme sweep source surface 312 target surface 310
volume cornea@A scheme sweep source surface 306 target surface 308
volume cornea@F scheme sweep source surface 332 target surface 330
volume cornea@E scheme sweep source surface 326 target surface 328
volume cornea@D scheme sweep source surface 321 target surface 323
volume cornea@C scheme sweep source surface 317 target surface 315

mesh volume all

block 1 cornea@A cornea@B cornea@E cornea@F
block 2 cornea@C cornea@D

# outer block
nodeset 2 cornea@C cornea@D
# "symmetry" plane
nodeset 20 surface 249 294 313 305 290 240
# fixed top surface
nodeset 30 surface 321 317
# inner surface
sideset 101 surface 310 308 330 328
sideset 102 surface 323 315
# outer surface 
nodeset 200 surface 312 306 332 326
sideset 200 surface 312 306 332 326 

# apex (?)
nodeset 300 vertex 599

export genesis "cornea.exo" overwrite
exit
